<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤©æ°£ & æ·¡æ°´å…¬è»Šè³‡è¨Š</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    button { margin: 10px; padding: 10px; font-size: 16px; cursor: pointer; }
    #weather-result, #bus-list, #bus-eta, #bus-suggestion, #bus-error {
      margin-top: 20px;
      text-align: left;
      display: inline-block;
    }
    ul#bus-list li { margin: 5px 0; list-style: disc inside; }
    #bus-error { color: red; }
  </style>
</head>
<body>
  <h1>ğŸŒ¦ å¤©æ°£æŸ¥è©¢ & ğŸš æ·¡æ°´å…¬è»Šè³‡è¨Š</h1>

  <!-- å¤©æ°£æŸ¥è©¢ -->
  <h2>ğŸŒ¤ æŸ¥è©¢å¤©æ°£</h2>
  <form id="weather-form">
    <label for="city">è«‹è¼¸å…¥åŸå¸‚åç¨±ï¼š</label>
    <input type="text" id="city" name="city" placeholder="ä¾‹å¦‚: Taipei">
    <button type="submit">æŸ¥è©¢</button>
  </form>
  <div id="weather-result"></div>

  <hr>

  <!-- å…¬è»Šè·¯ç·šæŸ¥è©¢ -->
  <h2>ğŸš æ·¡æ°´å…¬è»Šè·¯ç·š</h2>
  <button onclick="fetchBusRoutes()">å–å¾—æ·¡æ°´å…¬è»Šè·¯ç·š</button>
  <ul id="bus-list"></ul>

  <h3>ğŸš å…¬è»Šç›®å‰åœé ç‹€æ…‹</h3>
  <input id="eta-bus-number" placeholder="è¼¸å…¥å…¬è»Šè™Ÿç¢¼ï¼Œä¾‹å¦‚ï¼šç´…27">
  <button onclick="queryByBusNumber()">æŸ¥è©¢</button>
  <div id="bus-route-result" style="margin-top: 10px;"></div>
  
  <!-- ğŸš æŸ¥è©¢æŸç«™æœ‰å“ªäº›å…¬è»Šå³å°‡é€²ç«™ -->
  <h3>ğŸš å…¬è»Šå³å°‡é€²å…¥æŸç«™</h3>
  <input id="eta-stop-name" placeholder="è¼¸å…¥ç«™åï¼Œä¾‹å¦‚ï¼šæ·é‹æ·¡æ°´ç«™">
  <button onclick="queryByStopName()">æŸ¥è©¢</button>
  <div id="bus-stop-result" style="margin-top: 10px;"></div>

  <!-- æŸ¥è©¢èµ·é»èˆ‡çµ‚é»å¯æ­çš„å…¬è»Š -->
  <h2>ğŸš æŸ¥è©¢å¯æ­å…¬è»Š</h2>
  <input list="stops" id="start-stop" placeholder="è«‹è¼¸å…¥èµ·é»ç«™">
  <input list="stops" id="end-stop" placeholder="è«‹è¼¸å…¥çµ‚é»ç«™">
  <datalist id="stops">
    <option value="æ·é‹æ·¡æ°´ç«™">
    <option value="ç´…æ¯›åŸ">
    <option value="çœŸç†å¤§å­¸">
    <option value="æ¼äººç¢¼é ­">
  </datalist>
  <button onclick="fetchBusSuggestions()">æŸ¥è©¢å…¬è»Š</button>
  <p id="bus-error"></p>
  <div id="bus-suggestion"></div>

  <script>
    document.getElementById("weather-form").addEventListener("submit", function(event) {
      event.preventDefault();
      let city = document.getElementById("city").value;

      fetch("/weather", {
        method: "POST",
        body: new URLSearchParams({ city: city }),
        headers: { "Content-Type": "application/x-www-form-urlencoded" }
      })
        .then(response => response.json())
        .then(data => {
          let resultDiv = document.getElementById("weather-result");
          if (data.error) {
            resultDiv.innerHTML = `<p style="color: red;">âŒ ${data.error}</p>`;
          } else {
            resultDiv.innerHTML = `
              <h3>${data.city} å¤©æ°£è³‡è¨Š</h3>
              <p>ğŸŒ¡ æ°£æº«: ${data.temp}Â°C</p>
              <p>â˜ï¸ å¤©æ°£ç‹€æ³: ${data.description}</p>
              <p>ğŸ’§ æ¿•åº¦: ${data.humidity}%</p>
              <p>ğŸŒ¬ é¢¨é€Ÿ: ${data.wind_speed} m/s</p>
            `;
          }
        })
        .catch(error => console.error("éŒ¯èª¤:", error));
    });

    function fetchBusRoutes() {
      fetch("/bus/routes")
        .then(response => response.json())
        .then(data => {
          let list = document.getElementById("bus-list");
          list.innerHTML = "";
          data.forEach(bus => {
            let li = document.createElement("li");
            li.textContent = bus.RouteName;
            list.appendChild(li);
          });
        })
        .catch(error => console.error("éŒ¯èª¤:", error));
    }

    function queryByBusNumber() {
    const route = document.getElementById("eta-bus-number").value.trim();
    const div = document.getElementById("bus-route-result");
    div.innerHTML = "";

    if (!route) return div.innerHTML = "<p style='color:red;'>â— è«‹è¼¸å…¥å…¬è»Šè™Ÿç¢¼</p>";

    fetch(`/bus/eta/by-route?bus_number=${encodeURIComponent(route)}`)
        .then(res => res.json())
        .then(data => {
        if (data.error) {
            div.innerHTML = `<p style="color:red;">âŒ ${data.error}</p>`;
            return;
        }

        if (data.etas.length === 0) {
            div.innerHTML = `<p>â— æ²’æœ‰å³å°‡åˆ°ç«™çš„è³‡è¨Š</p>`;
            return;
        }

        let html = `<h4>${data.route} å³å°‡åœé çš„ç«™é»ï¼š</h4><ul>`;
        data.etas.forEach(item => {
            html += `<li>${item.StopName}ï¼š${item.EstimateTime} åˆ†é˜</li>`;
        });
        html += "</ul>";
        div.innerHTML = html;
        })
        .catch(error => {
        div.innerHTML = "<p style='color:red;'>âŒ æŸ¥è©¢å¤±æ•—</p>";
        console.error("ğŸš¨ éŒ¯èª¤:", error);
        });
    }

    function queryByStopName() {
    const stop = document.getElementById("eta-stop-name").value.trim();
    const div = document.getElementById("bus-stop-result");
    div.innerHTML = "";

    if (!stop) return div.innerHTML = "<p style='color:red;'>â— è«‹è¼¸å…¥ç«™å</p>";

    fetch(`/bus/eta/by-stop?stop_name=${encodeURIComponent(stop)}`)
        .then(res => res.json())
        .then(data => {
        if (data.error) {
            div.innerHTML = `<p style="color:red;">âŒ ${data.error}</p>`;
            return;
        }

        if (data.etas.length === 0) {
            div.innerHTML = `<p>â— ç›®å‰æ²’æœ‰å³å°‡é€²ç«™çš„å…¬è»Š</p>`;
            return;
        }

        let html = `<h4>${data.stop} å³å°‡é€²ç«™çš„å…¬è»Šï¼š</h4><ul>`;
        data.etas.forEach(item => {
            html += `<li>${item.RouteName}ï¼š${item.EstimateTime} åˆ†é˜</li>`;
        });
        html += "</ul>";
        div.innerHTML = html;
        })
        .catch(error => {
        div.innerHTML = "<p style='color:red;'>âŒ æŸ¥è©¢å¤±æ•—</p>";
        console.error("ğŸš¨ éŒ¯èª¤:", error);
        });
    }

    function fetchBusSuggestions() {
      let start = document.getElementById("start-stop").value.trim();
      let end = document.getElementById("end-stop").value.trim();
      const errorMsg = document.getElementById("bus-error");

      if (!start || !end) {
        errorMsg.textContent = "â— è«‹è¼¸å…¥èµ·é»èˆ‡çµ‚é»ç«™ï¼";
        return;
      } else {
        errorMsg.textContent = "";
      }

      fetch(`/bus/suggestions?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`)
        .then(response => {
          if (!response.ok) throw new Error("ç‹€æ…‹ç¢¼ï¼š" + response.status);
          return response.json();
        })
        .then(data => {
          let resultDiv = document.getElementById("bus-suggestion");
          resultDiv.innerHTML = "";

          if (data.error) {
            resultDiv.innerHTML = `<p>âŒ ${data.error}</p>`;
            return;
          }

          let html = "<h3>ğŸš å…¬è»Šå»ºè­°</h3>";

          if (data.direct_buses.length > 0) {
            html += "<h4>âœ… ç›´é”å…¬è»Šï¼š</h4><ul>";
            data.direct_buses.forEach(bus => {
              html += `<li>${bus}</li>`;
            });
            html += "</ul>";
          } else {
            html += "<p>âŒ æ²’æœ‰ç›´é”å…¬è»Š</p>";
          }

          if (data.transfer_buses.length > 0) {
            html += "<h4>ğŸ”„ å¯è½‰ä¹˜ï¼š</h4><ul>";
            data.transfer_buses.forEach(([bus1, bus2]) => {
              html += `<li>${bus1} â ${bus2}</li>`;
            });
            html += "</ul>";
          } else {
            html += "<p>âŒ æ²’æœ‰å¯è½‰ä¹˜çš„å…¬è»Š</p>";
          }

          resultDiv.innerHTML = html;
        })
        .catch(error => {
          console.error("ğŸš¨ API è«‹æ±‚å¤±æ•—ï¼š", error);
          document.getElementById("bus-suggestion").innerHTML = "<p>âŒ ç„¡æ³•å–å¾—å…¬è»Šå»ºè­°</p>";
        });
    }
  </script>
</body>
</html>