<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>天氣 & 淡水公車資訊</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    button { margin: 10px; padding: 10px; font-size: 16px; cursor: pointer; }
    #weather-result, #bus-list, #bus-eta, #bus-suggestion, #bus-error {
      margin-top: 20px;
      text-align: left;
      display: inline-block;
    }
    ul#bus-list li { margin: 5px 0; list-style: disc inside; }
    #bus-error { color: red; }
  </style>
</head>
<body>
  <h1>🌦 天氣查詢 & 🚍 淡水公車資訊</h1>

  <!-- 天氣查詢 -->
  <h2>🌤 查詢天氣</h2>
  <form id="weather-form">
    <label for="city">請輸入城市名稱：</label>
    <input type="text" id="city" name="city" placeholder="例如: Taipei">
    <button type="submit">查詢</button>
  </form>
  <div id="weather-result"></div>

  <hr>

  <!-- 公車路線查詢 -->
  <h2>🚍 淡水公車路線</h2>
  <button onclick="fetchBusRoutes()">取得淡水公車路線</button>
  <ul id="bus-list"></ul>

  <h3>🚍 公車目前停靠狀態</h3>
  <input id="eta-bus-number" placeholder="輸入公車號碼，例如：紅27">
  <button onclick="queryByBusNumber()">查詢</button>
  <div id="bus-route-result" style="margin-top: 10px;"></div>
  
  <!-- 🚏 查詢某站有哪些公車即將進站 -->
  <h3>🚏 公車即將進入某站</h3>
  <input id="eta-stop-name" placeholder="輸入站名，例如：捷運淡水站">
  <button onclick="queryByStopName()">查詢</button>
  <div id="bus-stop-result" style="margin-top: 10px;"></div>

  <!-- 查詢起點與終點可搭的公車 -->
  <h2>🚏 查詢可搭公車</h2>
  <input list="stops" id="start-stop" placeholder="請輸入起點站">
  <input list="stops" id="end-stop" placeholder="請輸入終點站">
  <datalist id="stops">
    <option value="捷運淡水站">
    <option value="紅毛城">
    <option value="真理大學">
    <option value="漁人碼頭">
  </datalist>
  <button onclick="fetchBusSuggestions()">查詢公車</button>
  <p id="bus-error"></p>
  <div id="bus-suggestion"></div>

  <script>
    document.getElementById("weather-form").addEventListener("submit", function(event) {
      event.preventDefault();
      let city = document.getElementById("city").value;

      fetch("/weather", {
        method: "POST",
        body: new URLSearchParams({ city: city }),
        headers: { "Content-Type": "application/x-www-form-urlencoded" }
      })
        .then(response => response.json())
        .then(data => {
          let resultDiv = document.getElementById("weather-result");
          if (data.error) {
            resultDiv.innerHTML = `<p style="color: red;">❌ ${data.error}</p>`;
          } else {
            resultDiv.innerHTML = `
              <h3>${data.city} 天氣資訊</h3>
              <p>🌡 氣溫: ${data.temp}°C</p>
              <p>☁️ 天氣狀況: ${data.description}</p>
              <p>💧 濕度: ${data.humidity}%</p>
              <p>🌬 風速: ${data.wind_speed} m/s</p>
            `;
          }
        })
        .catch(error => console.error("錯誤:", error));
    });

    function fetchBusRoutes() {
      fetch("/bus/routes")
        .then(response => response.json())
        .then(data => {
          let list = document.getElementById("bus-list");
          list.innerHTML = "";
          data.forEach(bus => {
            let li = document.createElement("li");
            li.textContent = bus.RouteName;
            list.appendChild(li);
          });
        })
        .catch(error => console.error("錯誤:", error));
    }

    function queryByBusNumber() {
    const route = document.getElementById("eta-bus-number").value.trim();
    const div = document.getElementById("bus-route-result");
    div.innerHTML = "";

    if (!route) return div.innerHTML = "<p style='color:red;'>❗ 請輸入公車號碼</p>";

    fetch(`/bus/eta/by-route?bus_number=${encodeURIComponent(route)}`)
        .then(res => res.json())
        .then(data => {
        if (data.error) {
            div.innerHTML = `<p style="color:red;">❌ ${data.error}</p>`;
            return;
        }

        if (data.etas.length === 0) {
            div.innerHTML = `<p>❗ 沒有即將到站的資訊</p>`;
            return;
        }

        let html = `<h4>${data.route} 即將停靠的站點：</h4><ul>`;
        data.etas.forEach(item => {
            html += `<li>${item.StopName}：${item.EstimateTime} 分鐘</li>`;
        });
        html += "</ul>";
        div.innerHTML = html;
        })
        .catch(error => {
        div.innerHTML = "<p style='color:red;'>❌ 查詢失敗</p>";
        console.error("🚨 錯誤:", error);
        });
    }

    function queryByStopName() {
    const stop = document.getElementById("eta-stop-name").value.trim();
    const div = document.getElementById("bus-stop-result");
    div.innerHTML = "";

    if (!stop) return div.innerHTML = "<p style='color:red;'>❗ 請輸入站名</p>";

    fetch(`/bus/eta/by-stop?stop_name=${encodeURIComponent(stop)}`)
        .then(res => res.json())
        .then(data => {
        if (data.error) {
            div.innerHTML = `<p style="color:red;">❌ ${data.error}</p>`;
            return;
        }

        if (data.etas.length === 0) {
            div.innerHTML = `<p>❗ 目前沒有即將進站的公車</p>`;
            return;
        }

        let html = `<h4>${data.stop} 即將進站的公車：</h4><ul>`;
        data.etas.forEach(item => {
            html += `<li>${item.RouteName}：${item.EstimateTime} 分鐘</li>`;
        });
        html += "</ul>";
        div.innerHTML = html;
        })
        .catch(error => {
        div.innerHTML = "<p style='color:red;'>❌ 查詢失敗</p>";
        console.error("🚨 錯誤:", error);
        });
    }

    function fetchBusSuggestions() {
      let start = document.getElementById("start-stop").value.trim();
      let end = document.getElementById("end-stop").value.trim();
      const errorMsg = document.getElementById("bus-error");

      if (!start || !end) {
        errorMsg.textContent = "❗ 請輸入起點與終點站！";
        return;
      } else {
        errorMsg.textContent = "";
      }

      fetch(`/bus/suggestions?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`)
        .then(response => {
          if (!response.ok) throw new Error("狀態碼：" + response.status);
          return response.json();
        })
        .then(data => {
          let resultDiv = document.getElementById("bus-suggestion");
          resultDiv.innerHTML = "";

          if (data.error) {
            resultDiv.innerHTML = `<p>❌ ${data.error}</p>`;
            return;
          }

          let html = "<h3>🚍 公車建議</h3>";

          if (data.direct_buses.length > 0) {
            html += "<h4>✅ 直達公車：</h4><ul>";
            data.direct_buses.forEach(bus => {
              html += `<li>${bus}</li>`;
            });
            html += "</ul>";
          } else {
            html += "<p>❌ 沒有直達公車</p>";
          }

          if (data.transfer_buses.length > 0) {
            html += "<h4>🔄 可轉乘：</h4><ul>";
            data.transfer_buses.forEach(([bus1, bus2]) => {
              html += `<li>${bus1} ➝ ${bus2}</li>`;
            });
            html += "</ul>";
          } else {
            html += "<p>❌ 沒有可轉乘的公車</p>";
          }

          resultDiv.innerHTML = html;
        })
        .catch(error => {
          console.error("🚨 API 請求失敗：", error);
          document.getElementById("bus-suggestion").innerHTML = "<p>❌ 無法取得公車建議</p>";
        });
    }
  </script>
</body>
</html>